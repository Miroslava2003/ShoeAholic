@model ShoeAholic.Models.ViewModels.CheckoutViewModel
@{
    ViewData["Title"] = "Завършване на поръчка";
}

<div class="container my-5">
    <h2 class="mb-4"><i class="bi bi-credit-card"></i> Завършване на поръчка</h2>

    <form asp-action="Checkout" method="post">
        <div class="row">
            <div class="col-lg-7">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-person"></i> Данни за контакт</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="FullName" class="form-label"></label>
                            <input asp-for="FullName" class="form-control" />
                            <span asp-validation-for="FullName" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label"></label>
                                <input asp-for="Email" type="email" class="form-control" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Phone" class="form-label"></label>
                                <input asp-for="Phone" type="tel" class="form-control" />
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-truck"></i> Начин на доставка</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" asp-for="DeliveryType" value="2" id="deliveryAddress" onchange="updateDeliveryPrice()" checked>
                                <label class="form-check-label" for="deliveryAddress"><strong>До адрес</strong> <span class="text-muted" id="addressPrice">@(Model.SubTotal >= 200 ? "(Безплатна)" : "(+7.99 лв.)")</span></label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" asp-for="DeliveryType" value="1" id="deliveryOffice" onchange="updateDeliveryPrice()">
                                <label class="form-check-label" for="deliveryOffice"><strong>Офис на куриер (Еконт/Спиди)</strong> <span class="text-muted" id="officePrice">@(Model.SubTotal >= 200 ? "(Безплатна)" : "(+5.99 лв.)")</span></label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="City" class="form-label"></label>
                                <input asp-for="City" class="form-control" placeholder="напр. София" />
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="PostalCode" class="form-label"></label>
                                <input asp-for="PostalCode" class="form-control" placeholder="напр. 1000" />
                                <span asp-validation-for="PostalCode" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Address" class="form-label"></label>
                            <input asp-for="Address" class="form-control" placeholder="Адрес или име на офис" />
                            <span asp-validation-for="Address" class="text-danger"></span>
                            <small class="text-muted">При офис на куриер напишете име на офиса</small>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-wallet2"></i> Начин на плащане</h5></div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" asp-for="PaymentType" value="1" id="cashOnDelivery" checked>
                            <label class="form-check-label" for="cashOnDelivery"><strong>Наложен платеж</strong><p class="text-muted mb-0 small">Плащате при получаване</p></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" asp-for="PaymentType" value="2" id="cardPayment">
                            <label class="form-check-label" for="cardPayment"><strong>Плащане с карта</strong><p class="text-muted mb-0 small">Сигурно онлайн плащане</p></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-light"><h5 class="mb-0">Обобщение на поръчката</h5></div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2"><span>Артикули:</span><span>@Model.ItemsCount бр.</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>Междинна сума:</span><strong>@Model.SubTotal.ToString("F2") лв.</strong></div>
                        <div class="d-flex justify-content-between mb-3"><span>Доставка:</span><strong id="deliveryPriceDisplay">@(Model.SubTotal >= 200 ? "<span class=\"text-success\">Безплатна</span>" : "7.99 лв.")</strong></div>
                        @if (Model.SubTotal >= 200)
                        {
                            <div class="alert alert-success mb-3"><i class="bi bi-check-circle"></i> Безплатна доставка над 200 лв.!</div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-3"><i class="bi bi-info-circle"></i> Още @((200 - Model.SubTotal).ToString("F2")) лв. за безплатна доставка</div>
                        }
                        <hr />
                        @{
                            var deliveryPrice = Model.SubTotal >= 200 ? 0 : 7.99m;
                            var total = Model.SubTotal + deliveryPrice;
                        }
                        <div class="d-flex justify-content-between mb-4"><h5>Общо:</h5><h5 class="text-primary" id="totalPriceDisplay">@total.ToString("F2") лв.</h5></div>
                        <button type="submit" class="btn btn-primary btn-lg w-100"><i class="bi bi-check-circle"></i> Завърши поръчката</button>
                        <a asp-controller="Cart" asp-action="Index" class="btn btn-outline-secondary w-100 mt-2"><i class="bi bi-arrow-left"></i> Обратно към количката</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        const subTotal = @Model.SubTotal;
        const freeShippingThreshold = 200;
        function updateDeliveryPrice() {
            const deliveryType = document.querySelector('input[name="DeliveryType"]:checked').value;
            const isAddress = deliveryType === '2';
            let deliveryPrice = 0;
            if (subTotal < freeShippingThreshold) { deliveryPrice = isAddress ? 7.99 : 5.99; }
            const total = subTotal + deliveryPrice;
            const deliveryDisplay = document.getElementById('deliveryPriceDisplay');
            const totalDisplay = document.getElementById('totalPriceDisplay');
            deliveryDisplay.innerHTML = deliveryPrice === 0 ? '<span class="text-success">Безплатна</span>' : deliveryPrice.toFixed(2) + ' лв.';
            totalDisplay.textContent = total.toFixed(2) + ' лв.';
        }
    </script>
}
